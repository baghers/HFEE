
echo 1 > /sys/bus/i2c/drivers/INA231/0-0045/enable
echo 1 > /sys/bus/i2c/drivers/INA231/0-0040/enable
echo 1 > /sys/bus/i2c/drivers/INA231/0-0041/enable
echo 1 > /sys/bus/i2c/drivers/INA231/0-0044/enable


echo userspace >/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu1/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu2/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu3/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu4/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu5/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu6/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu7/cpufreq/scaling_governor
echo 2
echo 1400000 >/sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
echo 1400000 >/sys/devices/system/cpu/cpu1/cpufreq/scaling_max_freq
echo 1400000 >/sys/devices/system/cpu/cpu2/cpufreq/scaling_max_freq
echo 1400000 >/sys/devices/system/cpu/cpu3/cpufreq/scaling_max_freq
echo 2000000 >/sys/devices/system/cpu/cpu4/cpufreq/scaling_max_freq
echo 2000000 >/sys/devices/system/cpu/cpu5/cpufreq/scaling_max_freq
echo 2000000 >/sys/devices/system/cpu/cpu6/cpufreq/scaling_max_freq
echo 2000000 >/sys/devices/system/cpu/cpu7/cpufreq/scaling_max_freq
echo 3
echo 1400000 >/sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq
echo 1400000 >/sys/devices/system/cpu/cpu1/cpufreq/scaling_min_freq
echo 1400000 >/sys/devices/system/cpu/cpu2/cpufreq/scaling_min_freq
echo 1400000 >/sys/devices/system/cpu/cpu3/cpufreq/scaling_min_freq
echo 2000000 >/sys/devices/system/cpu/cpu4/cpufreq/scaling_min_freq
echo 2000000 >/sys/devices/system/cpu/cpu5/cpufreq/scaling_min_freq
echo 2000000 >/sys/devices/system/cpu/cpu6/cpufreq/scaling_min_freq
echo 2000000 >/sys/devices/system/cpu/cpu7/cpufreq/scaling_min_freq
echo 4
cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq

	pid0="$(pidof hmmer_base.ArmLinuxGnuAbi-)"
	pid1="$(pidof bzip2_base.ArmLinuxGnuAbi-)"
	pid2="$(pidof mcf_base.ArmLinuxGnuAbi-)"
	pid3="$(pidof h264ref_base.ArmLinuxGnuAbi-)"

	
	if [ $(echo ${#pid0}) -gt 0 ]
	then
		echo 1
	else
	./spec/CPU2006/456.hmmer/run/run_base_ref_ArmLinuxGnuAbi-.0000/hmmer_base.ArmLinuxGnuAbi-  --num 50000 ./spec/CPU2006/456.hmmer/run/run_base_ref_ArmLinuxGnuAbi-.0000/nph3.hmm &	
	fi
	if [ $(echo ${#pid1}) -gt 0 ]
	then
		echo 2
	else
	./spec/CPU2006/401.bzip2/run/run_base_ref_ArmLinuxGnuAbi-.0000/bzip2_base.ArmLinuxGnuAbi- ./spec/CPU2006/401.bzip2/run/run_base_ref_ArmLinuxGnuAbi-.0000/input.program & 

	fi
	if [ $(echo ${#pid2}) -gt 0 ]
	then
		echo 3
    else
    ./spec/CPU2006/429.mcf/run/run_base_ref_ArmLinuxGnuAbi-.0000/mcf_base.ArmLinuxGnuAbi- ./spec/CPU2006/429.mcf/run/run_base_ref_ArmLinuxGnuAbi-.0000/inp.in -o ./spec/CPU2006/429.mcf/run/run_base_ref_ArmLinuxGnuAbi-.0000/inp.out -e ./spec/CPU2006/429.mcf/run/run_base_ref_ArmLinuxGnuAbi-.0000/inp.err &
    fi
	if [ $(echo ${#pid3}) -gt 0 ]
	then
		echo 4
	else
	./spec/CPU2006/464.h264ref/run/run_base_ref_ArmLinuxGnuAbi-.0000/h264ref_base.ArmLinuxGnuAbi- -d ./spec/CPU2006/464.h264ref/run/run_base_ref_ArmLinuxGnuAbi-.0000/foreman_ref_encoder_main.cfg & 
	fi
	sleep 5s
	pid1="$(pidof hmmer_base.ArmLinuxGnuAbi-)"
	pid2="$(pidof bzip2_base.ArmLinuxGnuAbi-)"
	pid3="$(pidof mcf_base.ArmLinuxGnuAbi-)"
	pid0="$(pidof h264ref_base.ArmLinuxGnuAbi-)"

	taskset -cp 4 $pid1
	taskset -cp 5 $pid2
	taskset -cp 0 $pid3
	taskset -cp 1 $pid4
	oldpcnt=0
while [ $pid3 -gt 0 ]
do
	pid1="$(pidof hmmer_base.ArmLinuxGnuAbi-)"
	pid2="$(pidof bzip2_base.ArmLinuxGnuAbi-)"
	pid3="$(pidof mcf_base.ArmLinuxGnuAbi-)"
	pid0="$(pidof h264ref_base.ArmLinuxGnuAbi-)"
	p0=""
	p1=""
	p2=""
	p3=""
	pcnt=0
	avablablebig=2
	avablablelittle=2
	##########################
	if [ $(echo ${#pid2}) -gt 0 ]
	then
		p2="taskset -cp 4 $pid2"
		avablablebig=$(( $avablablebig - 1 ))
		pcnt=$(( $pcnt + 1 ))
	fi
	##########################
	if [ $(echo ${#pid1}) -gt 0 ]
	then
		if [ $avablablebig -lt 2 ] 
		then
			p1="taskset -cp 5 $pid1"
		else
			p1="taskset -cp 4 $pid1"
		fi
		avablablebig=$(( $avablablebig - 1 ))
		pcnt=$(( $pcnt + 1 ))
	fi
	##########################
	if [ $(echo ${#pid3}) -gt 0 ]
	then
		pcnt=$(( $pcnt + 1 ))
		if [ $avablablebig -gt 1 ] 
		then
			p3="taskset -cp 4 $pid3"
			avablablebig=$(( $avablablebig - 1 ))
		elif [ $avablablebig -gt 0 ]
			 then
				p3="taskset -cp 5 $pid3"
				avablablebig=$(( $avablablebig - 1 ))
			  else				   
						p3="taskset -cp 1 $pid3"
						avablablelittle=$(( $avablablelittle - 1 ))
		fi
		
	fi
	##########################
	if [ $(echo ${#pid0}) -gt 0 ]
	then
		if [ $avablablebig -gt 1 ] 
		then
			p0="taskset -cp 4 $pid0"
			avablablebig=$(( $avablablebig - 1 ))
		elif [ $avablablebig -gt 0 ]
			 then
				p0="taskset -cp 5 $pid0"
				avablablebig=$(( $avablablebig - 1 ))
			 elif [ $avablablelittle -gt 1 ]
			 	  then
						p0="taskset -cp 1 $pid0"
			      else
						p0="taskset -cp 0 $pid0"
				  fi
		pcnt=$(( $pcnt + 1 ))
	fi
	
	if [ $pcnt != $oldpcnt ]
	then
		$p0
		$p1
		$p2
		$p3
	fi	
	

	
	CPU0_FREQ=$((`cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq`/1000))
	CPU4_FREQ=$((`cat /sys/devices/system/cpu/cpu4/cpufreq/scaling_cur_freq`/1000))
	A7_W=`cat /sys/bus/i2c/drivers/INA231/0-0045/sensor_W`
	A15_W=`cat /sys/bus/i2c/drivers/INA231/0-0040/sensor_W`
	echo "${j} $(date +'%H:%M:%S') ${CPU0_FREQ} ${CPU4_FREQ} ${A7_W} ${A15_W}" >> resmyth2r.log
	sleep 1s
	oldpcnt=$pcnt
done

