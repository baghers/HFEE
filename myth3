avgips0=1933894742
avgips1=1607103149
avgips2=192636435
avgips3=1966248105

echo 1 > /sys/bus/i2c/drivers/INA231/0-0045/enable
echo 1 > /sys/bus/i2c/drivers/INA231/0-0040/enable
echo 1 > /sys/bus/i2c/drivers/INA231/0-0041/enable
echo 1 > /sys/bus/i2c/drivers/INA231/0-0044/enable



echo userspace >/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu1/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu2/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu3/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu4/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu5/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu6/cpufreq/scaling_governor
echo userspace >/sys/devices/system/cpu/cpu7/cpufreq/scaling_governor
echo 2
echo 1400000 >/sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
echo 1400000 >/sys/devices/system/cpu/cpu1/cpufreq/scaling_max_freq
echo 1400000 >/sys/devices/system/cpu/cpu2/cpufreq/scaling_max_freq
echo 1400000 >/sys/devices/system/cpu/cpu3/cpufreq/scaling_max_freq
echo 2000000 >/sys/devices/system/cpu/cpu4/cpufreq/scaling_max_freq
echo 2000000 >/sys/devices/system/cpu/cpu5/cpufreq/scaling_max_freq
echo 2000000 >/sys/devices/system/cpu/cpu6/cpufreq/scaling_max_freq
echo 2000000 >/sys/devices/system/cpu/cpu7/cpufreq/scaling_max_freq
echo 3
echo 1400000 >/sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq
echo 1400000 >/sys/devices/system/cpu/cpu1/cpufreq/scaling_min_freq
echo 1400000 >/sys/devices/system/cpu/cpu2/cpufreq/scaling_min_freq
echo 1400000 >/sys/devices/system/cpu/cpu3/cpufreq/scaling_min_freq
echo 2000000 >/sys/devices/system/cpu/cpu4/cpufreq/scaling_min_freq
echo 2000000 >/sys/devices/system/cpu/cpu5/cpufreq/scaling_min_freq
echo 2000000 >/sys/devices/system/cpu/cpu6/cpufreq/scaling_min_freq
echo 2000000 >/sys/devices/system/cpu/cpu7/cpufreq/scaling_min_freq
echo 4
cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq

pid0="$(pidof hmmer_base.ArmLinuxGnuAbi-)"
pid1="$(pidof bzip2_base.ArmLinuxGnuAbi-)"
pid2="$(pidof mcf_base.ArmLinuxGnuAbi-)"
pid3="$(pidof h264ref_base.ArmLinuxGnuAbi-)"

#####################kill previous processes
if [ $(echo ${#pid0}) -gt 0 ]
then
	kill $pid0
fi
if [ $(echo ${#pid1}) -gt 0 ]
then
	kill $pid1
fi
if [ $(echo ${#pid2}) -gt 0 ]
then
	kill $pid2
fi
if [ $(echo ${#pid3}) -gt 0 ]
then
	kill $pid3
fi
#####################
	

./spec/CPU2006/456.hmmer/run/run_base_ref_ArmLinuxGnuAbi-.0000/hmmer_base.ArmLinuxGnuAbi-  --num 50000 ./spec/CPU2006/456.hmmer/run/run_base_ref_ArmLinuxGnuAbi-.0000/nph3.hmm &	
t0=$(($(date +%s%N)/1000000))

./spec/CPU2006/401.bzip2/run/run_base_ref_ArmLinuxGnuAbi-.0000/bzip2_base.ArmLinuxGnuAbi- ./spec/CPU2006/401.bzip2/run/run_base_ref_ArmLinuxGnuAbi-.0000/input.program & 
t1=$(($(date +%s%N)/1000000))

./spec/CPU2006/429.mcf/run/run_base_ref_ArmLinuxGnuAbi-.0000/mcf_base.ArmLinuxGnuAbi- ./spec/CPU2006/429.mcf/run/run_base_ref_ArmLinuxGnuAbi-.0000/inp.in -o ./spec/CPU2006/429.mcf/run/run_base_ref_ArmLinuxGnuAbi-.0000/inp.out -e ./spec/CPU2006/429.mcf/run/run_base_ref_ArmLinuxGnuAbi-.0000/inp.err &
t2=$(($(date +%s%N)/1000000))

./spec/CPU2006/464.h264ref/run/run_base_ref_ArmLinuxGnuAbi-.0000/h264ref_base.ArmLinuxGnuAbi- -d ./spec/CPU2006/464.h264ref/run/run_base_ref_ArmLinuxGnuAbi-.0000/foreman_ref_encoder_main.cfg & 
t3=$(($(date +%s%N)/1000000))

pid0="$(pidof hmmer_base.ArmLinuxGnuAbi-)"
pid1="$(pidof bzip2_base.ArmLinuxGnuAbi-)"
pid2="$(pidof mcf_base.ArmLinuxGnuAbi-)"
pid3="$(pidof h264ref_base.ArmLinuxGnuAbi-)"

taskset -cp 3 $pid0
af0=3
taskset -cp 7 $pid1
af1=7
taskset -cp 6 $pid2
af2=6
taskset -cp 2 $pid3
af3=2

oldpcnt=0
prevt0=$t0
prevt1=$t1
prevt2=$t2
prevt3=$t3
totalins0=0
totalins1=0
totalins2=0
totalins3=0
totaldur0=0
totaldur1=0
totaldur2=0
totaldur3=0
while [ $pid2 -gt 0 ]
do
	p0=""
	p1=""
	p2=""
	p3=""
	pcnt=0
	avablablebig=2
	avablablelittle=2
	pid0="$(pidof hmmer_base.ArmLinuxGnuAbi-)"
	pid1="$(pidof bzip2_base.ArmLinuxGnuAbi-)"
	pid2="$(pidof mcf_base.ArmLinuxGnuAbi-)"
	pid3="$(pidof h264ref_base.ArmLinuxGnuAbi-)"
	
	if [ $(echo ${#pid0}) -gt 0 ]
	then
		if [ $af0 != 2 ] && [ $af0 != 3 ]
		then
			pcname="armv7_cortex_a15/inst_retired/"
		else
			pcname="armv7_cortex_a7/inst_retired/"
		fi

		s1=$(($(date +%s%N)/1000000))
		poutput=`perf stat -B -e ${pcname}  -C ${af0} sleep 0.1 2>&1`
		s2=$(($(date +%s%N)/1000000))
		DIFF0b=$(($(( $s2 - $s1 ))))
		v0="${af0}':"
		v7="${pcname}"
		rest0=${poutput#*$v0}
		rest7=${poutput#*$v7}
		p0=$(( ${#poutput} - ${#rest0} - ${#v0} ))
		instructions0b=$(echo ${poutput:(p0+${#v0}-1):100}| cut -d ' ' -f 2)
		instructions0b="$(echo "${instructions0b//,}")"
		curt=$(($(date +%s%N)/1000000))		
		dur=$(( $curt-$prevt0 ))
		instructions0b=$(( $instructions0b*$dur ))
		instructions0b=$(( $instructions0b/$DIFF0b ))
		prevt0=$curt
		totalins0=$(( $totalins0 + $instructions0b ))
		totaldur0=$(($(( $curt - t0 ))))
		progress0="$(echo "scale=2; $(( $totalins0*1000 ))/$(( $avgips0*$totaldur0 ))" | bc)"
	fi
	if [ $(echo ${#pid1}) -gt 0 ]
	then
		if [ $af1 != 2 ] && [ $af1 != 3 ]
		then
			pcname="armv7_cortex_a15/inst_retired/"
		else
			pcname="armv7_cortex_a7/inst_retired/"
		fi
		s1=$(($(date +%s%N)/1000000))
		poutput=`perf stat -B -e ${pcname}  -C ${af1} sleep 0.1 2>&1`
		s2=$(($(date +%s%N)/1000000))
		DIFF0b=$(($(( $s2 - $s1 ))))
		v0="${af1}':"
		v7="${pcname}"
		rest0=${poutput#*$v0}
		rest7=${poutput#*$v7}
		p0=$(( ${#poutput} - ${#rest0} - ${#v0} ))
		instructions0b=$(echo ${poutput:(p0+${#v0}-1):100}| cut -d ' ' -f 2)
		instructions0b="$(echo "${instructions0b//,}")"
		curt=$(($(date +%s%N)/1000000))		
		dur=$(( $curt-$prevt1 ))
		instructions0b=$(( $instructions0b*$dur ))
		instructions0b=$(( $instructions0b/$DIFF0b ))
		prevt1=$curt
		totalins1=$(( $totalins1 + $instructions0b ))
		totaldur1=$(($(( $curt - t1 ))))
		progress1="$(echo "scale=2; $(( $totalins1*1000 ))/$(( $avgips1*$totaldur1 ))" | bc)"
	fi	
	if [ $(echo ${#pid2}) -gt 0 ]
	then
		if [ $af2 != 2 ] && [ $af2 != 3 ]
		then
			pcname="armv7_cortex_a15/inst_retired/"
		else
			pcname="armv7_cortex_a7/inst_retired/"
		fi
		s1=$(($(date +%s%N)/1000000))
		poutput=`perf stat -B -e ${pcname}  -C ${af2} sleep 0.1 2>&1`
		s2=$(($(date +%s%N)/1000000))
		DIFF0b=$(($(( $s2 - $s1 ))))
		v0="${af2}':"
		v7="${pcname}"
		rest0=${poutput#*$v0}
		rest7=${poutput#*$v7}
		p0=$(( ${#poutput} - ${#rest0} - ${#v0} ))
		instructions0b=$(echo ${poutput:(p0+${#v0}-1):100}| cut -d ' ' -f 2)
		instructions0b="$(echo "${instructions0b//,}")"
		curt=$(($(date +%s%N)/1000000))		
		dur=$(( $curt-$prevt2 ))
		instructions0b=$(( $instructions0b*$dur ))
		instructions0b=$(( $instructions0b/$DIFF0b ))
		prevt2=$curt
		totalins2=$(( $totalins2 + $instructions0b ))
		totaldur2=$(($(( $curt - t2 ))))
		progress2="$(echo "scale=2; $(( $totalins2*1000 ))/$(( $avgips2*$totaldur2 ))" | bc)"
	fi	
	if [ $(echo ${#pid3}) -gt 0 ]
	then
		if [ $af3 != 2 ] && [ $af3 != 3 ]
		then
			pcname="armv7_cortex_a15/inst_retired/"
		else
			pcname="armv7_cortex_a7/inst_retired/"
		fi
		s1=$(($(date +%s%N)/1000000))
		poutput=`perf stat -B -e ${pcname}  -C ${af3} sleep 0.1 2>&1`
		s2=$(($(date +%s%N)/1000000))
		DIFF0b=$(($(( $s2 - $s1 ))))
		v0="${af3}':"
		v7="${pcname}"
		rest0=${poutput#*$v0}
		rest7=${poutput#*$v7}
		p0=$(( ${#poutput} - ${#rest0} - ${#v0} ))
		instructions0b=$(echo ${poutput:(p0+${#v0}-1):100}| cut -d ' ' -f 2)
		instructions0b="$(echo "${instructions0b//,}")"
		curt=$(($(date +%s%N)/1000000))		
		dur=$(( $curt-$prevt3 ))
		instructions0b=$(( $instructions0b*$dur ))
		instructions0b=$(( $instructions0b/$DIFF0b ))
		prevt3=$curt
		totalins3=$(( $totalins3 + $instructions0b ))
		totaldur3=$(($(( $curt - t3 ))))
		progress3="$(echo "scale=2; $(( $totalins3*1000 ))/$(( $avgips3*$totaldur3 ))" | bc)"
	fi
	##########################
	if [ $(echo ${#pid2}) -gt 0 ]
	then
		p2="taskset -cp 6 $pid2"
		af2=6
		avablablebig=$(( $avablablebig - 1 ))
		pcnt=$(( $pcnt + 1 ))
	fi
	##########################
	if [ $(echo ${#pid1}) -gt 0 ]
	then
		if [ $avablablebig -lt 2 ] 
		then
			af1=7
			p1="taskset -cp 7 $pid1"
		else
			af1=6
			p1="taskset -cp 6 $pid1"
		fi
		avablablebig=$(( $avablablebig - 1 ))
		pcnt=$(( $pcnt + 1 ))
	fi
	##########################
	if [ $(echo ${#pid3}) -gt 0 ]
	then
		pcnt=$(( $pcnt + 1 ))
		if [ $avablablebig -gt 1 ] 
		then
			af3=6
			p3="taskset -cp 6 $pid3"
			avablablebig=$(( $avablablebig - 1 ))
		elif [ $avablablebig -gt 0 ]
			 then
				af3=7
				p3="taskset -cp 7 $pid3"
				avablablebig=$(( $avablablebig - 1 ))
			  else	
					af3=2			   
					p3="taskset -cp 2 $pid3"
					avablablelittle=$(( $avablablelittle - 1 ))
		fi
		
	fi
	##########################
	if [ $(echo ${#pid0}) -gt 0 ]
	then
		if [ $avablablebig -gt 1 ] 
		then
			af0=6
			p0="taskset -cp 6 $pid0"
			avablablebig=$(( $avablablebig - 1 ))
		elif [ $avablablebig -gt 0 ]
			 then
				af0=7
				p0="taskset -cp 7 $pid0"
				avablablebig=$(( $avablablebig - 1 ))
			 elif [ $avablablelittle -gt 1 ]
			 	  then
						af0=2
						p0="taskset -cp 2 $pid0"
			      else
						af0=3
						p0="taskset -cp 3 $pid0"
				  fi
		pcnt=$(( $pcnt + 1 ))
	fi
	
	if [ $pcnt != $oldpcnt ]
	then
		$p0
		$p1
		$p2
		$p3
	fi	
	

	
	CPU0_FREQ=$((`cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq`/1000))
	CPU4_FREQ=$((`cat /sys/devices/system/cpu/cpu4/cpufreq/scaling_cur_freq`/1000))
	A7_W=`cat /sys/bus/i2c/drivers/INA231/0-0045/sensor_W`
	A15_W=`cat /sys/bus/i2c/drivers/INA231/0-0040/sensor_W`
	echo "${j} $(date +'%H:%M:%S') ${CPU0_FREQ} ${CPU4_FREQ} ${A7_W} ${A15_W} -$pid0 -$pid1 -$pid2 -$pid3 -${totalins0} -${totalins1} -${totalins2} -${totalins3} -$totaldur0 -$totaldur1 -$totaldur2 -$totaldur3 -$af0 -$af1 -$af2 -$af3 -$progress0 -$progress1 -$progress2 -$progress3 " >> resmyth3.log
	##sleep 1s
	oldpcnt=$pcnt
done

